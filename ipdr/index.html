<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPDR Analysis | Punjab Investigation Tools</title>
    <meta name="description" content="Analyze IP Data Records (IPDR) for investigation purposes.">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/tool-common.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body>
    <header class="header">
        <div class="header-container">
            <a href="/" class="logo" style="text-decoration: none; color: inherit;">
                <div class="logo-icon">
                    <i class="fas fa-shield-halved"></i>
                </div>
                <div class="logo-text">
                    <span class="logo-title">Punjab Investigation Tools</span>
                    <span class="logo-subtitle">IPDR Analysis</span>
                </div>
            </a>
            <div class="header-actions">
                <a href="/" class="back-home-btn">
                    <i class="fas fa-home"></i> All Tools
                </a>
            </div>
        </div>
    </header>

    <main class="main-content">
        <section class="hero-section">
            <div class="hero-content">
                <h1><i class="fas fa-network-wired"></i> IPDR Analysis</h1>
                <p>Analyze IP Data Records to track internet usage, sessions, and data patterns</p>
            </div>
        </section>

        <section class="input-section">
            <div class="file-drop-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
                <i class="fas fa-file-csv"></i>
                <h4>Upload IPDR File</h4>
                <p>Drop CSV/Excel file here or click to select</p>
                <span class="supported-formats">Expected columns: MSISDN, IP Address, Start Time, End Time, Data Volume, Domain/URL, Cell ID</span>
                <input type="file" id="fileInput" accept=".csv,.xlsx,.xls,.txt" hidden>
            </div>

            <div class="column-mapping" id="columnMapping" style="display: none;">
                <h4><i class="fas fa-columns"></i> Map Your Columns</h4>
                <p style="color: var(--text-secondary); margin-bottom: 15px;">Select which columns in your file correspond to IPDR fields</p>
                <div class="mapping-grid">
                    <div class="mapping-item">
                        <label>MSISDN / Phone Number</label>
                        <select id="mapMsisdn"></select>
                    </div>
                    <div class="mapping-item">
                        <label>IP Address</label>
                        <select id="mapIP"></select>
                    </div>
                    <div class="mapping-item">
                        <label>Start Time</label>
                        <select id="mapStartTime"></select>
                    </div>
                    <div class="mapping-item">
                        <label>End Time (optional)</label>
                        <select id="mapEndTime"></select>
                    </div>
                    <div class="mapping-item">
                        <label>Data Volume (bytes)</label>
                        <select id="mapVolume"></select>
                    </div>
                    <div class="mapping-item">
                        <label>Domain / URL (optional)</label>
                        <select id="mapDomain"></select>
                    </div>
                    <div class="mapping-item">
                        <label>Cell ID / Location (optional)</label>
                        <select id="mapCellId"></select>
                    </div>
                    <div class="mapping-item">
                        <label>Protocol / App (optional)</label>
                        <select id="mapProtocol"></select>
                    </div>
                </div>
                <button class="verify-btn" onclick="analyzeWithMapping()">
                    <i class="fas fa-chart-line"></i> Analyze IPDR
                </button>
            </div>
        </section>

        <section class="results-section" id="resultsSection" style="display: none;">
            <!-- Summary Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-globe"></i></div>
                    <div class="stat-value" id="totalSessions">0</div>
                    <div class="stat-label">Total Sessions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-network-wired"></i></div>
                    <div class="stat-value" id="uniqueIPs">0</div>
                    <div class="stat-label">Unique IPs</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-database"></i></div>
                    <div class="stat-value" id="totalData">0 MB</div>
                    <div class="stat-label">Total Data</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-calendar-days"></i></div>
                    <div class="stat-value" id="dateRange">-</div>
                    <div class="stat-label">Date Range</div>
                </div>
            </div>

            <!-- Top Domains -->
            <div class="result-card" id="domainSection" style="display: none;">
                <h3><i class="fas fa-link"></i> Most Accessed Domains</h3>
                <div class="data-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Domain</th>
                                <th>Sessions</th>
                                <th>Data Volume</th>
                                <th>First Access</th>
                                <th>Last Access</th>
                            </tr>
                        </thead>
                        <tbody id="topDomainsBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- IP Analysis -->
            <div class="result-card">
                <h3><i class="fas fa-server"></i> IP Address Analysis</h3>
                <div class="data-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>IP Address</th>
                                <th>Sessions</th>
                                <th>Data Volume</th>
                                <th>Duration</th>
                                <th>First Seen</th>
                                <th>Last Seen</th>
                            </tr>
                        </thead>
                        <tbody id="ipAnalysisBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Charts -->
            <div class="charts-grid">
                <div class="chart-card">
                    <h4><i class="fas fa-chart-bar"></i> Hourly Usage Pattern</h4>
                    <canvas id="hourlyChart"></canvas>
                </div>
                <div class="chart-card">
                    <h4><i class="fas fa-chart-pie"></i> Data by Protocol/Type</h4>
                    <canvas id="protocolChart"></canvas>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-card full-width">
                    <h4><i class="fas fa-chart-area"></i> Daily Data Usage</h4>
                    <canvas id="dailyChart"></canvas>
                </div>
            </div>

            <!-- Cell Tower Analysis -->
            <div class="result-card" id="cellTowerSection" style="display: none;">
                <h3><i class="fas fa-tower-cell"></i> Location / Cell Tower Analysis</h3>
                <div class="data-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Cell ID / Location</th>
                                <th>Sessions</th>
                                <th>Data Volume</th>
                                <th>First Seen</th>
                                <th>Last Seen</th>
                            </tr>
                        </thead>
                        <tbody id="cellTowerBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Timeline -->
            <div class="result-card">
                <h3><i class="fas fa-timeline"></i> Session Timeline (Sample)</h3>
                <div class="timeline-container" id="timelineContainer">
                </div>
            </div>

            <div class="action-buttons">
                <button class="action-btn" onclick="downloadAnalysis()">
                    <i class="fas fa-download"></i> Download Analysis
                </button>
                <button class="action-btn" onclick="resetTool()">
                    <i class="fas fa-redo"></i> Analyze New IPDR
                </button>
            </div>
        </section>

        <section class="info-section">
            <h3><i class="fas fa-info-circle"></i> About IPDR Analysis</h3>
            <div class="info-grid">
                <div class="info-card">
                    <div class="info-icon"><i class="fas fa-satellite-dish"></i></div>
                    <h4>What is IPDR?</h4>
                    <p>IP Data Records contain internet session data including timestamps, IP addresses, data volumes, and accessed domains from telecom service providers.</p>
                </div>
                <div class="info-card">
                    <div class="info-icon"><i class="fas fa-search"></i></div>
                    <h4>Investigation Use</h4>
                    <p>IPDR helps identify online activity patterns, visited websites, usage times, and can correlate with physical locations via cell tower data.</p>
                </div>
                <div class="info-card">
                    <div class="info-icon"><i class="fas fa-user-shield"></i></div>
                    <h4>Privacy Protected</h4>
                    <p>All IPDR analysis happens locally in your browser. No internet session data is uploaded to any server.</p>
                </div>
            </div>
        </section>
    </main>

    <footer class="footer">
        <div class="footer-content">
            <p><i class="fas fa-shield-check"></i> All processing happens locally in your browser. No data is uploaded to any server.</p>
            <p>© 2024-<span id="currentYear"></span> Punjab Investigation Tools</p>
        </div>
    </footer>

    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toastMessage">Action completed</span>
    </div>

    <style>
        .column-mapping {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 16px;
            padding: 25px;
            margin-top: 20px;
        }
        .column-mapping h4 {
            color: var(--accent-blue);
            margin-bottom: 5px;
        }
        .mapping-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .mapping-item label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }
        .mapping-item select {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--card-border);
            background: rgba(0, 0, 0, 0.3);
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 16px;
            padding: 25px;
            text-align: center;
        }
        .stat-icon {
            font-size: 2rem;
            color: var(--accent-blue);
            margin-bottom: 10px;
        }
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        .chart-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 16px;
            padding: 25px;
        }
        .chart-card.full-width {
            grid-column: 1 / -1;
        }
        .chart-card h4 {
            color: var(--accent-blue);
            margin-bottom: 15px;
        }
        .timeline-container {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
        }
        .timeline-item {
            display: flex;
            gap: 15px;
            padding: 15px;
            border-left: 3px solid var(--accent-blue);
            margin-left: 10px;
            margin-bottom: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 0 8px 8px 0;
        }
        .timeline-time {
            min-width: 150px;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
        }
        .timeline-content {
            flex: 1;
        }
        .timeline-ip {
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-primary);
        }
        .timeline-details {
            color: var(--success-color);
            font-size: 0.9rem;
        }
        .data-high { border-left-color: #ef4444; }
        .data-medium { border-left-color: var(--warning-color); }
        .data-low { border-left-color: var(--success-color); }
        .supported-formats {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 10px;
        }
        .data-table-container {
            overflow-x: auto;
        }
    </style>

    <script>
        document.getElementById('currentYear').textContent = new Date().getFullYear();

        let rawData = [];
        let parsedData = [];
        let headers = [];
        let charts = {};

        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            if (e.dataTransfer.files.length > 0) {
                handleFile(e.dataTransfer.files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    rawData = results.data;
                    headers = results.meta.fields || [];
                    
                    if (rawData.length === 0) {
                        showToast('No data found in the file');
                        return;
                    }
                    
                    showColumnMapping();
                }
            });
        }

        function showColumnMapping() {
            const mappingSection = document.getElementById('columnMapping');
            mappingSection.style.display = 'block';
            
            const selects = ['mapMsisdn', 'mapIP', 'mapStartTime', 'mapEndTime', 'mapVolume', 'mapDomain', 'mapCellId', 'mapProtocol'];
            const autoMatch = {
                mapMsisdn: ['msisdn', 'phone', 'number', 'mobile', 'subscriber'],
                mapIP: ['ip', 'ip_address', 'ipaddress', 'source_ip', 'dest_ip', 'user_ip'],
                mapStartTime: ['start', 'start_time', 'starttime', 'begin', 'timestamp', 'date_time'],
                mapEndTime: ['end', 'end_time', 'endtime', 'finish', 'stop'],
                mapVolume: ['volume', 'bytes', 'data', 'size', 'upload', 'download', 'total_bytes'],
                mapDomain: ['domain', 'url', 'host', 'hostname', 'website', 'destination'],
                mapCellId: ['cell', 'cellid', 'cell_id', 'lac', 'location', 'tower', 'site'],
                mapProtocol: ['protocol', 'app', 'application', 'service', 'type', 'port']
            };
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">-- Select Column --</option>';
                
                headers.forEach(header => {
                    const option = document.createElement('option');
                    option.value = header;
                    option.textContent = header;
                    
                    const keywords = autoMatch[selectId] || [];
                    if (keywords.some(kw => header.toLowerCase().includes(kw))) {
                        option.selected = true;
                    }
                    
                    select.appendChild(option);
                });
            });
        }

        function analyzeWithMapping() {
            const mapping = {
                msisdn: document.getElementById('mapMsisdn').value,
                ip: document.getElementById('mapIP').value,
                startTime: document.getElementById('mapStartTime').value,
                endTime: document.getElementById('mapEndTime').value,
                volume: document.getElementById('mapVolume').value,
                domain: document.getElementById('mapDomain').value,
                cellId: document.getElementById('mapCellId').value,
                protocol: document.getElementById('mapProtocol').value
            };
            
            if (!mapping.startTime) {
                showToast('Please map at least the Start Time column');
                return;
            }
            
            parsedData = rawData.map(row => ({
                msisdn: row[mapping.msisdn] || '',
                ip: row[mapping.ip] || '',
                startTime: parseDateTime(row[mapping.startTime]),
                endTime: mapping.endTime ? parseDateTime(row[mapping.endTime]) : null,
                volume: parseInt(row[mapping.volume]) || 0,
                domain: row[mapping.domain] || '',
                cellId: row[mapping.cellId] || '',
                protocol: row[mapping.protocol] || 'Unknown'
            })).filter(r => r.startTime);
            
            if (parsedData.length === 0) {
                showToast('Could not parse any valid records');
                return;
            }
            
            analyzeData();
        }

        function parseDateTime(str) {
            if (!str) return null;
            const date = new Date(str);
            return isNaN(date.getTime()) ? null : date;
        }

        function analyzeData() {
            document.getElementById('resultsSection').style.display = 'block';
            
            // Summary stats
            const totalSessions = parsedData.length;
            const uniqueIPs = new Set(parsedData.map(r => r.ip).filter(Boolean)).size;
            const totalBytes = parsedData.reduce((sum, r) => sum + r.volume, 0);
            
            const dates = parsedData.map(r => r.startTime).sort((a, b) => a - b);
            const dateRange = dates.length > 0 
                ? `${dates[0].toLocaleDateString()} - ${dates[dates.length - 1].toLocaleDateString()}`
                : '-';
            
            document.getElementById('totalSessions').textContent = totalSessions.toLocaleString();
            document.getElementById('uniqueIPs').textContent = uniqueIPs.toLocaleString();
            document.getElementById('totalData').textContent = formatBytes(totalBytes);
            document.getElementById('dateRange').textContent = dateRange;
            
            // Domain analysis
            if (parsedData.some(r => r.domain)) {
                analyzeDomains();
            }
            
            // IP analysis
            analyzeIPs();
            
            // Charts
            createHourlyChart();
            createProtocolChart();
            createDailyChart();
            
            // Cell tower analysis
            if (parsedData.some(r => r.cellId)) {
                analyzeCellTowers();
            }
            
            // Timeline
            createTimeline();
            
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
        }

        function analyzeDomains() {
            document.getElementById('domainSection').style.display = 'block';
            
            const domainStats = {};
            parsedData.filter(r => r.domain).forEach(r => {
                const domain = extractDomain(r.domain);
                if (!domainStats[domain]) {
                    domainStats[domain] = { count: 0, volume: 0, first: r.startTime, last: r.startTime };
                }
                domainStats[domain].count++;
                domainStats[domain].volume += r.volume;
                if (r.startTime < domainStats[domain].first) domainStats[domain].first = r.startTime;
                if (r.startTime > domainStats[domain].last) domainStats[domain].last = r.startTime;
            });
            
            const sorted = Object.entries(domainStats)
                .sort((a, b) => b[1].count - a[1].count)
                .slice(0, 20);
            
            const tbody = document.getElementById('topDomainsBody');
            tbody.innerHTML = sorted.map(([domain, stats], idx) => `
                <tr>
                    <td>${idx + 1}</td>
                    <td><span class="mono">${domain}</span></td>
                    <td>${stats.count.toLocaleString()}</td>
                    <td>${formatBytes(stats.volume)}</td>
                    <td>${stats.first.toLocaleString()}</td>
                    <td>${stats.last.toLocaleString()}</td>
                </tr>
            `).join('');
        }

        function extractDomain(url) {
            try {
                if (!url.includes('://')) url = 'http://' + url;
                return new URL(url).hostname;
            } catch {
                return url.split('/')[0];
            }
        }

        function analyzeIPs() {
            const ipStats = {};
            parsedData.filter(r => r.ip).forEach(r => {
                if (!ipStats[r.ip]) {
                    ipStats[r.ip] = { count: 0, volume: 0, duration: 0, first: r.startTime, last: r.startTime };
                }
                ipStats[r.ip].count++;
                ipStats[r.ip].volume += r.volume;
                if (r.endTime && r.startTime) {
                    ipStats[r.ip].duration += (r.endTime - r.startTime) / 1000;
                }
                if (r.startTime < ipStats[r.ip].first) ipStats[r.ip].first = r.startTime;
                if (r.startTime > ipStats[r.ip].last) ipStats[r.ip].last = r.startTime;
            });
            
            const sorted = Object.entries(ipStats)
                .sort((a, b) => b[1].count - a[1].count)
                .slice(0, 20);
            
            const tbody = document.getElementById('ipAnalysisBody');
            tbody.innerHTML = sorted.map(([ip, stats]) => `
                <tr>
                    <td><span class="mono">${ip}</span></td>
                    <td>${stats.count.toLocaleString()}</td>
                    <td>${formatBytes(stats.volume)}</td>
                    <td>${formatDuration(stats.duration)}</td>
                    <td>${stats.first.toLocaleString()}</td>
                    <td>${stats.last.toLocaleString()}</td>
                </tr>
            `).join('');
        }

        function createHourlyChart() {
            const hourCounts = new Array(24).fill(0);
            const hourVolume = new Array(24).fill(0);
            
            parsedData.forEach(r => {
                const hour = r.startTime.getHours();
                hourCounts[hour]++;
                hourVolume[hour] += r.volume;
            });
            
            if (charts.hourly) charts.hourly.destroy();
            
            const ctx = document.getElementById('hourlyChart').getContext('2d');
            charts.hourly = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Array.from({ length: 24 }, (_, i) => `${i}:00`),
                    datasets: [{
                        label: 'Sessions',
                        data: hourCounts,
                        backgroundColor: 'rgba(59, 130, 246, 0.7)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function createProtocolChart() {
            const protocolCounts = {};
            parsedData.forEach(r => {
                protocolCounts[r.protocol] = (protocolCounts[r.protocol] || 0) + 1;
            });
            
            if (charts.protocol) charts.protocol.destroy();
            
            const ctx = document.getElementById('protocolChart').getContext('2d');
            charts.protocol = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(protocolCounts),
                    datasets: [{
                        data: Object.values(protocolCounts),
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(139, 92, 246, 0.8)',
                            'rgba(236, 72, 153, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#94a3b8' }
                        }
                    }
                }
            });
        }

        function createDailyChart() {
            const dayVolume = {};
            parsedData.forEach(r => {
                const day = r.startTime.toISOString().split('T')[0];
                dayVolume[day] = (dayVolume[day] || 0) + r.volume;
            });
            
            const sortedDays = Object.keys(dayVolume).sort();
            
            if (charts.daily) charts.daily.destroy();
            
            const ctx = document.getElementById('dailyChart').getContext('2d');
            charts.daily = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedDays,
                    datasets: [{
                        label: 'Data Volume (MB)',
                        data: sortedDays.map(d => dayVolume[d] / (1024 * 1024)),
                        borderColor: 'rgba(16, 185, 129, 1)',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        x: {
                            ticks: { color: '#94a3b8', maxTicksLimit: 10 },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function analyzeCellTowers() {
            document.getElementById('cellTowerSection').style.display = 'block';
            
            const cellStats = {};
            parsedData.filter(r => r.cellId).forEach(r => {
                if (!cellStats[r.cellId]) {
                    cellStats[r.cellId] = { count: 0, volume: 0, first: r.startTime, last: r.startTime };
                }
                cellStats[r.cellId].count++;
                cellStats[r.cellId].volume += r.volume;
                if (r.startTime < cellStats[r.cellId].first) cellStats[r.cellId].first = r.startTime;
                if (r.startTime > cellStats[r.cellId].last) cellStats[r.cellId].last = r.startTime;
            });
            
            const sorted = Object.entries(cellStats)
                .sort((a, b) => b[1].count - a[1].count)
                .slice(0, 20);
            
            const tbody = document.getElementById('cellTowerBody');
            tbody.innerHTML = sorted.map(([cellId, stats]) => `
                <tr>
                    <td><span class="mono">${cellId}</span></td>
                    <td>${stats.count.toLocaleString()}</td>
                    <td>${formatBytes(stats.volume)}</td>
                    <td>${stats.first.toLocaleString()}</td>
                    <td>${stats.last.toLocaleString()}</td>
                </tr>
            `).join('');
        }

        function createTimeline() {
            const sample = parsedData.slice(0, 50);
            const container = document.getElementById('timelineContainer');
            
            container.innerHTML = sample.map(r => {
                const volumeMB = r.volume / (1024 * 1024);
                const volumeClass = volumeMB > 10 ? 'data-high' : volumeMB > 1 ? 'data-medium' : 'data-low';
                
                return `
                    <div class="timeline-item ${volumeClass}">
                        <div class="timeline-time">${r.startTime.toLocaleString()}</div>
                        <div class="timeline-content">
                            <div class="timeline-ip">${r.ip || 'No IP'} ${r.domain ? '→ ' + extractDomain(r.domain) : ''}</div>
                            <div class="timeline-details">
                                ${formatBytes(r.volume)} • ${r.protocol}
                                ${r.cellId ? ` • Cell: ${r.cellId}` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDuration(seconds) {
            if (seconds < 60) return `${Math.round(seconds)}s`;
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m`;
            const hours = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            return `${hours}h ${mins}m`;
        }

        function downloadAnalysis() {
            const report = {
                summary: {
                    totalSessions: parsedData.length,
                    dateRange: {
                        start: parsedData[0]?.startTime,
                        end: parsedData[parsedData.length - 1]?.startTime
                    }
                },
                data: parsedData,
                generatedAt: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ipdr_analysis_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Analysis report downloaded');
        }

        function resetTool() {
            rawData = [];
            parsedData = [];
            headers = [];
            fileInput.value = '';
            document.getElementById('columnMapping').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('domainSection').style.display = 'none';
            document.getElementById('cellTowerSection').style.display = 'none';
            Object.values(charts).forEach(c => c?.destroy());
            charts = {};
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMessage').textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
