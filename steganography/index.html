<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Steganography Tool | Punjab Investigation Tools</title>
    <meta name="description" content="Detect and analyze hidden data in images. Extract hidden messages and detect steganographic content.">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Application CSS -->
    <link rel="stylesheet" href="../css/styles.css">
    
    <style>
        /* Tab Navigation */
        .tabs-container {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .tab-btn {
            padding: 12px 24px;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 10px;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            font-size: 0.95rem;
            font-family: inherit;
        }
        .tab-btn:hover {
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }
        .tab-btn.active {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-color: transparent;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        /* Tool Card Styles */
        .tool-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
        }
        .tool-card h3 {
            color: var(--accent-secondary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .tool-card > p {
            color: var(--text-secondary);
            margin-bottom: 25px;
        }
        
        /* Upload Zone */
        .upload-zone {
            border: 2px dashed var(--card-border);
            border-radius: 16px;
            padding: 50px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 25px;
        }
        .upload-zone:hover {
            border-color: var(--accent-primary);
            background: rgba(99, 102, 241, 0.05);
        }
        .upload-zone.dragover {
            border-color: var(--accent-primary);
            background: rgba(99, 102, 241, 0.1);
        }
        .upload-zone.has-image {
            border-style: solid;
            padding: 20px;
        }
        .upload-zone i.upload-icon {
            font-size: 3rem;
            color: var(--accent-primary);
            margin-bottom: 15px;
        }
        .upload-zone p {
            color: var(--text-secondary);
            margin: 5px 0;
        }
        .upload-zone input {
            display: none;
        }
        .upload-zone img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 12px;
            margin-bottom: 15px;
        }
        
        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--card-border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.3s;
            box-sizing: border-box;
        }
        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        .form-group textarea {
            min-height: 120px;
            resize: vertical;
            font-family: 'JetBrains Mono', monospace;
        }
        
        /* Action Button */
        .action-btn-primary {
            width: 100%;
            padding: 16px 28px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.3);
        }
        .action-btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(99, 102, 241, 0.5);
        }
        .action-btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid var(--card-border);
            box-shadow: none;
        }
        
        /* Results Section */
        .results-section {
            display: none;
            margin-top: 30px;
        }
        .results-section.visible {
            display: block;
        }
        
        /* Analysis Results */
        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .analysis-card {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 20px;
        }
        .analysis-card h4 {
            color: var(--accent-primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1rem;
        }
        .analysis-card .value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 5px;
        }
        .analysis-card .description {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        /* Detection Indicator */
        .detection-indicator {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .detection-indicator.positive {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.4);
        }
        .detection-indicator.negative {
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid rgba(16, 185, 129, 0.4);
        }
        .detection-indicator.uncertain {
            background: rgba(245, 158, 11, 0.15);
            border: 1px solid rgba(245, 158, 11, 0.4);
        }
        .detection-icon {
            font-size: 2rem;
        }
        .detection-indicator.positive .detection-icon { color: #ef4444; }
        .detection-indicator.negative .detection-icon { color: #10b981; }
        .detection-indicator.uncertain .detection-icon { color: #f59e0b; }
        .detection-text h4 {
            margin: 0 0 5px 0;
            color: var(--text-primary);
        }
        .detection-text p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        /* LSB Visualization */
        .lsb-visualization {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        .lsb-channel {
            text-align: center;
        }
        .lsb-channel canvas {
            width: 100%;
            max-width: 200px;
            height: auto;
            border-radius: 8px;
            background: #000;
        }
        .lsb-channel p {
            margin-top: 10px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        /* Histogram */
        .histogram-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }
        .histogram-container canvas {
            width: 100%;
            height: 200px;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .action-btn {
            flex: 1;
            min-width: 120px;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--card-border);
            border-radius: 10px;
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
            font-family: inherit;
            font-size: 0.9rem;
        }
        .action-btn:hover {
            border-color: var(--accent-primary);
            background: rgba(99, 102, 241, 0.1);
        }
        
        /* Encode Result */
        .encode-result {
            margin-top: 20px;
            text-align: center;
        }
        .encode-result img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 12px;
            margin-bottom: 15px;
        }
        
        /* Tips */
        .tips-card {
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }
        .tips-card h5 {
            color: var(--accent-primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .tips-card ul {
            margin: 0;
            padding-left: 20px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        .tips-card li {
            margin-bottom: 8px;
        }
        
        /* Progress */
        .progress-container {
            margin: 25px 0;
            display: none;
        }
        .progress-container.visible {
            display: block;
        }
        .progress-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 10px;
            transition: width 0.3s ease;
            width: 0%;
        }
        .progress-status {
            margin-top: 10px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            text-align: center;
        }
        
        /* Chi-Square Chart */
        .chi-square-chart {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }
        
        /* Loading/Processing States */
        .action-btn-primary.loading,
        .action-btn.loading {
            pointer-events: none;
            opacity: 0.8;
        }
        .action-btn-primary.loading i,
        .action-btn.loading i {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Full Page Overlay Loader */
        .processing-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .processing-overlay.visible {
            display: flex;
        }
        .processing-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .processing-text {
            margin-top: 20px;
            color: white;
            font-size: 1.1rem;
            text-align: center;
        }
        .processing-subtext {
            margin-top: 8px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <!-- Processing Overlay -->
    <div class="processing-overlay" id="processingOverlay">
        <div class="processing-spinner"></div>
        <div class="processing-text" id="processingText">Processing...</div>
        <div class="processing-subtext" id="processingSubtext">Please wait</div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <a href="/" class="logo" style="text-decoration: none; color: inherit;">
                <div class="logo-icon">
                    <i class="fas fa-shield-halved"></i>
                </div>
                <div class="logo-text">
                    <span class="logo-title">Punjab Investigation Tools</span>
                    <span class="logo-subtitle">Steganography Tool</span>
                </div>
            </a>
            <div class="header-actions">
                <a href="/" class="back-home-btn" style="display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: var(--text-secondary); text-decoration: none; font-size: 0.9rem;">
                    <i class="fas fa-home"></i> All Tools
                </a>
                <div class="status-badge">
                    <span class="status-dot"></span>
                    <span>Ready</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Hero Section -->
        <section class="hero-section">
            <div class="hero-content">
                <h1><i class="fas fa-user-secret"></i> Steganography Tool</h1>
                <p>Detect and analyze hidden data in images. Encode secret messages or extract hidden content using LSB steganography techniques.</p>
            </div>
        </section>

        <!-- Tool Section -->
        <section class="content-section">
            <!-- Tabs -->
            <div class="tabs-container">
                <button class="tab-btn active" onclick="switchTab('detect')">
                    <i class="fas fa-search"></i> Detect Hidden Data
                </button>
                <button class="tab-btn" onclick="switchTab('decode')">
                    <i class="fas fa-lock-open"></i> Extract Message
                </button>
                <button class="tab-btn" onclick="switchTab('encode')">
                    <i class="fas fa-lock"></i> Hide Message
                </button>
            </div>

            <!-- Detect Tab -->
            <div id="detectTab" class="tab-content active">
                <div class="tool-card">
                    <h3><i class="fas fa-magnifying-glass"></i> Detect Steganography</h3>
                    <p>Upload an image to analyze for hidden data using multiple detection techniques including LSB analysis, chi-square test, and entropy analysis.</p>
                    
                    <div class="upload-zone" id="detectUploadZone" onclick="document.getElementById('detectInput').click()">
                        <i class="fas fa-cloud-upload-alt upload-icon" id="detectUploadIcon"></i>
                        <p id="detectUploadText">Click to upload or drag & drop image here</p>
                        <p style="font-size: 0.85rem;">Supports PNG, BMP (lossless formats work best)</p>
                        <input type="file" id="detectInput" accept="image/*" onchange="handleDetectUpload(event)">
                        <img id="detectPreview" style="display: none;">
                    </div>
                    
                    <button class="action-btn-primary" id="detectBtn" onclick="analyzeImage()" disabled>
                        <i class="fas fa-search"></i> Analyze Image
                    </button>
                    
                    <div class="progress-container" id="detectProgress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="detectProgressFill"></div>
                        </div>
                        <div class="progress-status" id="detectProgressStatus">Analyzing...</div>
                    </div>
                    
                    <div class="results-section" id="detectResults">
                        <div class="detection-indicator" id="detectionIndicator">
                            <i class="fas fa-question-circle detection-icon"></i>
                            <div class="detection-text">
                                <h4 id="detectionTitle">Analysis Complete</h4>
                                <p id="detectionMessage">Results are shown below</p>
                            </div>
                        </div>
                        
                        <div class="analysis-grid">
                            <div class="analysis-card">
                                <h4><i class="fas fa-chart-bar"></i> LSB Randomness</h4>
                                <div class="value" id="lsbRandomness">-</div>
                                <div class="description">Higher values suggest hidden data</div>
                            </div>
                            <div class="analysis-card">
                                <h4><i class="fas fa-wave-square"></i> Entropy Score</h4>
                                <div class="value" id="entropyScore">-</div>
                                <div class="description">Measures data randomness (0-8)</div>
                            </div>
                            <div class="analysis-card">
                                <h4><i class="fas fa-calculator"></i> Chi-Square</h4>
                                <div class="value" id="chiSquare">-</div>
                                <div class="description">Statistical anomaly detection</div>
                            </div>
                            <div class="analysis-card">
                                <h4><i class="fas fa-percentage"></i> Confidence</h4>
                                <div class="value" id="confidenceScore">-</div>
                                <div class="description">Overall detection confidence</div>
                            </div>
                        </div>
                        
                        <h4 style="color: var(--text-primary); margin: 25px 0 15px;"><i class="fas fa-layer-group"></i> LSB Plane Visualization</h4>
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 15px;">
                            Extracted least significant bits from each color channel. Patterns or text may indicate hidden data.
                        </p>
                        <div class="lsb-visualization">
                            <div class="lsb-channel">
                                <canvas id="lsbRed" width="200" height="200"></canvas>
                                <p>Red Channel LSB</p>
                            </div>
                            <div class="lsb-channel">
                                <canvas id="lsbGreen" width="200" height="200"></canvas>
                                <p>Green Channel LSB</p>
                            </div>
                            <div class="lsb-channel">
                                <canvas id="lsbBlue" width="200" height="200"></canvas>
                                <p>Blue Channel LSB</p>
                            </div>
                        </div>
                        
                        <div class="action-buttons">
                            <button class="action-btn" onclick="downloadAnalysis()">
                                <i class="fas fa-download"></i> Download Report
                            </button>
                            <button class="action-btn" onclick="clearDetect()">
                                <i class="fas fa-trash"></i> Clear
                            </button>
                        </div>
                    </div>
                    
                    <div class="tips-card">
                        <h5><i class="fas fa-info-circle"></i> About Detection</h5>
                        <ul>
                            <li><strong>LSB Analysis:</strong> Examines the least significant bits of pixels for hidden data patterns</li>
                            <li><strong>Chi-Square Test:</strong> Statistical test that detects non-random distributions in pixel values</li>
                            <li><strong>Entropy Analysis:</strong> Measures randomness - embedded data often increases entropy</li>
                            <li><strong>Best Results:</strong> Use PNG or BMP images (JPEG compression destroys hidden data)</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Decode Tab -->
            <div id="decodeTab" class="tab-content">
                <div class="tool-card">
                    <h3><i class="fas fa-lock-open"></i> Extract Hidden Message</h3>
                    <p>Extract text hidden in an image using LSB steganography. The message must have been encoded using standard LSB technique.</p>
                    
                    <div class="upload-zone" id="decodeUploadZone" onclick="document.getElementById('decodeInput').click()">
                        <i class="fas fa-cloud-upload-alt upload-icon" id="decodeUploadIcon"></i>
                        <p id="decodeUploadText">Click to upload or drag & drop image here</p>
                        <p style="font-size: 0.85rem;">Must be PNG or BMP (lossless format)</p>
                        <input type="file" id="decodeInput" accept="image/png,image/bmp" onchange="handleDecodeUpload(event)">
                        <img id="decodePreview" style="display: none;">
                    </div>
                    
                    <button class="action-btn-primary" id="decodeBtn" onclick="decodeMessage()" disabled>
                        <i class="fas fa-key"></i> Extract Message
                    </button>
                    
                    <div class="results-section" id="decodeResults">
                        <div class="form-group">
                            <label><i class="fas fa-message"></i> Extracted Message</label>
                            <textarea id="decodedMessage" readonly placeholder="Extracted message will appear here..."></textarea>
                        </div>
                        
                        <div class="action-buttons">
                            <button class="action-btn" onclick="copyDecodedMessage()">
                                <i class="fas fa-copy"></i> Copy Message
                            </button>
                            <button class="action-btn" onclick="clearDecode()">
                                <i class="fas fa-trash"></i> Clear
                            </button>
                        </div>
                    </div>
                    
                    <div class="tips-card">
                        <h5><i class="fas fa-lightbulb"></i> Tips</h5>
                        <ul>
                            <li>Only works with images that have data hidden using LSB steganography</li>
                            <li>JPEG images lose hidden data due to lossy compression</li>
                            <li>The image must not have been edited or re-saved after encoding</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Encode Tab -->
            <div id="encodeTab" class="tab-content">
                <div class="tool-card">
                    <h3><i class="fas fa-lock"></i> Hide Message in Image</h3>
                    <p>Embed a secret message into an image using LSB steganography. The output image will look identical to the original.</p>
                    
                    <div class="upload-zone" id="encodeUploadZone" onclick="document.getElementById('encodeInput').click()">
                        <i class="fas fa-cloud-upload-alt upload-icon" id="encodeUploadIcon"></i>
                        <p id="encodeUploadText">Click to upload or drag & drop image here</p>
                        <p style="font-size: 0.85rem;">Use PNG for best results</p>
                        <input type="file" id="encodeInput" accept="image/*" onchange="handleEncodeUpload(event)">
                        <img id="encodePreview" style="display: none;">
                    </div>
                    
                    <div class="form-group">
                        <label for="secretMessage"><i class="fas fa-pen"></i> Secret Message</label>
                        <textarea id="secretMessage" placeholder="Enter the message you want to hide..." oninput="updateCapacity()"></textarea>
                        <p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 8px;">
                            <span id="charUsed">0</span> / <span id="maxChars">0</span> characters
                        </p>
                    </div>
                    
                    <button class="action-btn-primary" id="encodeBtn" onclick="encodeMessage()" disabled>
                        <i class="fas fa-wand-magic-sparkles"></i> Hide Message
                    </button>
                    
                    <div class="results-section" id="encodeResults">
                        <h4 style="color: var(--accent-secondary); margin-bottom: 15px;">
                            <i class="fas fa-check-circle" style="color: #10b981;"></i> Message Hidden Successfully
                        </h4>
                        <div class="encode-result">
                            <canvas id="encodedCanvas" style="max-width: 100%; border-radius: 12px;"></canvas>
                        </div>
                        <div class="action-buttons">
                            <button class="action-btn" onclick="downloadEncoded()">
                                <i class="fas fa-download"></i> Download Image
                            </button>
                            <button class="action-btn" onclick="clearEncode()">
                                <i class="fas fa-trash"></i> Clear
                            </button>
                        </div>
                    </div>
                    
                    <div class="tips-card">
                        <h5><i class="fas fa-shield-alt"></i> Security Notes</h5>
                        <ul>
                            <li><strong>Save as PNG:</strong> JPEG compression will destroy the hidden message</li>
                            <li><strong>Don't edit:</strong> Any modifications to the image may corrupt the message</li>
                            <li><strong>Capacity:</strong> Larger images can hide more data</li>
                            <li><strong>Detection:</strong> LSB steganography can be detected with proper tools</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <p>Punjab Investigation Tools - Steganography Tool</p>
            <p style="font-size: 0.85rem; opacity: 0.7;">All processing done locally in your browser</p>
        </div>
    </footer>

    <script>
        // State
        let detectImage = null;
        let decodeImage = null;
        let encodeImage = null;
        let analysisResults = null;

        // Tab switching
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.closest('.tab-btn').classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');
        }

        // Setup drag and drop for all zones
        ['detect', 'decode', 'encode'].forEach(zone => {
            const uploadZone = document.getElementById(zone + 'UploadZone');
            
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });
            
            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('dragover');
            });
            
            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('image/')) {
                    const input = document.getElementById(zone + 'Input');
                    const dt = new DataTransfer();
                    dt.items.add(file);
                    input.files = dt.files;
                    
                    if (zone === 'detect') handleDetectUpload({ target: input });
                    else if (zone === 'decode') handleDecodeUpload({ target: input });
                    else handleEncodeUpload({ target: input });
                }
            });
        });

        // Handle detect upload
        function handleDetectUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                detectImage = new Image();
                detectImage.onload = function() {
                    document.getElementById('detectPreview').src = e.target.result;
                    document.getElementById('detectPreview').style.display = 'block';
                    document.getElementById('detectUploadIcon').style.display = 'none';
                    document.getElementById('detectUploadText').textContent = 'Click to change image';
                    document.getElementById('detectUploadZone').classList.add('has-image');
                    document.getElementById('detectBtn').disabled = false;
                    document.getElementById('detectResults').classList.remove('visible');
                };
                detectImage.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // Handle decode upload
        function handleDecodeUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                decodeImage = new Image();
                decodeImage.onload = function() {
                    document.getElementById('decodePreview').src = e.target.result;
                    document.getElementById('decodePreview').style.display = 'block';
                    document.getElementById('decodeUploadIcon').style.display = 'none';
                    document.getElementById('decodeUploadText').textContent = 'Click to change image';
                    document.getElementById('decodeUploadZone').classList.add('has-image');
                    document.getElementById('decodeBtn').disabled = false;
                    document.getElementById('decodeResults').classList.remove('visible');
                };
                decodeImage.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // Handle encode upload
        function handleEncodeUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                encodeImage = new Image();
                encodeImage.onload = function() {
                    document.getElementById('encodePreview').src = e.target.result;
                    document.getElementById('encodePreview').style.display = 'block';
                    document.getElementById('encodeUploadIcon').style.display = 'none';
                    document.getElementById('encodeUploadText').textContent = 'Click to change image';
                    document.getElementById('encodeUploadZone').classList.add('has-image');
                    document.getElementById('encodeResults').classList.remove('visible');
                    updateCapacity();
                };
                encodeImage.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // Analyze image for steganography
        function analyzeImage() {
            if (!detectImage) return;
            
            const progress = document.getElementById('detectProgress');
            const fill = document.getElementById('detectProgressFill');
            const status = document.getElementById('detectProgressStatus');
            const btn = document.getElementById('detectBtn');
            
            btn.disabled = true;
            btn.classList.add('loading');
            btn.innerHTML = '<i class="fas fa-spinner"></i> Analyzing...';
            progress.classList.add('visible');
            
            // Create canvas
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = detectImage.width;
            canvas.height = detectImage.height;
            ctx.drawImage(detectImage, 0, 0);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            fill.style.width = '20%';
            status.textContent = 'Analyzing LSB patterns...';
            
            setTimeout(() => {
                // LSB Analysis
                const lsbRandomness = calculateLSBRandomness(data);
                fill.style.width = '40%';
                status.textContent = 'Calculating entropy...';
                
                setTimeout(() => {
                    // Entropy
                    const entropy = calculateEntropy(data);
                    fill.style.width = '60%';
                    status.textContent = 'Running chi-square test...';
                    
                    setTimeout(() => {
                        // Chi-square
                        const chiSquare = calculateChiSquare(data);
                        fill.style.width = '80%';
                        status.textContent = 'Generating visualization...';
                        
                        setTimeout(() => {
                            // Generate LSB visualizations
                            generateLSBVisualization(data, canvas.width, canvas.height);
                            
                            // Calculate confidence
                            const confidence = calculateConfidence(lsbRandomness, entropy, chiSquare);
                            
                            fill.style.width = '100%';
                            status.textContent = 'Analysis complete!';
                            
                            // Display results
                            analysisResults = { lsbRandomness, entropy, chiSquare, confidence };
                            displayDetectionResults(analysisResults);
                            
                            setTimeout(() => {
                                progress.classList.remove('visible');
                                btn.disabled = false;
                                btn.classList.remove('loading');
                                btn.innerHTML = '<i class="fas fa-search"></i> Analyze Image';
                            }, 500);
                        }, 200);
                    }, 200);
                }, 200);
            }, 200);
        }

        // Calculate LSB randomness
        function calculateLSBRandomness(data) {
            let transitions = 0;
            let lastBit = data[0] & 1;
            
            for (let i = 4; i < data.length; i += 4) {
                const bit = data[i] & 1;
                if (bit !== lastBit) transitions++;
                lastBit = bit;
            }
            
            const totalPixels = data.length / 4;
            return (transitions / totalPixels * 100).toFixed(2);
        }

        // Calculate entropy
        function calculateEntropy(data) {
            const histogram = new Array(256).fill(0);
            const totalPixels = data.length / 4;
            
            for (let i = 0; i < data.length; i += 4) {
                histogram[data[i]]++;
            }
            
            let entropy = 0;
            for (let i = 0; i < 256; i++) {
                if (histogram[i] > 0) {
                    const p = histogram[i] / totalPixels;
                    entropy -= p * Math.log2(p);
                }
            }
            
            return entropy.toFixed(3);
        }

        // Calculate chi-square
        function calculateChiSquare(data) {
            const pairs = new Array(128).fill(0);
            
            for (let i = 0; i < data.length; i += 4) {
                const val = data[i];
                const pairIndex = Math.floor(val / 2);
                pairs[pairIndex]++;
            }
            
            let chiSquare = 0;
            for (let i = 0; i < 128; i++) {
                const expected = pairs[i] / 2;
                if (expected > 0) {
                    const observed = (pairs[i] % 2 === 0) ? pairs[i] / 2 : (pairs[i] + 1) / 2;
                    chiSquare += Math.pow(observed - expected, 2) / expected;
                }
            }
            
            return chiSquare.toFixed(2);
        }

        // Calculate confidence
        function calculateConfidence(lsb, entropy, chi) {
            let score = 0;
            
            // LSB randomness around 50% is suspicious
            if (Math.abs(lsb - 50) < 5) score += 40;
            else if (Math.abs(lsb - 50) < 10) score += 20;
            
            // High entropy is suspicious
            if (entropy > 7.5) score += 30;
            else if (entropy > 7) score += 15;
            
            // Low chi-square indicates embedding
            if (chi < 100) score += 30;
            else if (chi < 200) score += 15;
            
            return Math.min(score, 100);
        }

        // Generate LSB visualization
        function generateLSBVisualization(data, width, height) {
            ['Red', 'Green', 'Blue'].forEach((channel, offset) => {
                const canvas = document.getElementById('lsb' + channel);
                const ctx = canvas.getContext('2d');
                
                // Scale to fit
                const scale = Math.min(200 / width, 200 / height);
                canvas.width = Math.floor(width * scale);
                canvas.height = Math.floor(height * scale);
                
                const lsbData = ctx.createImageData(canvas.width, canvas.height);
                
                for (let y = 0; y < canvas.height; y++) {
                    for (let x = 0; x < canvas.width; x++) {
                        const srcX = Math.floor(x / scale);
                        const srcY = Math.floor(y / scale);
                        const srcIdx = (srcY * width + srcX) * 4;
                        const dstIdx = (y * canvas.width + x) * 4;
                        
                        const lsb = (data[srcIdx + offset] & 1) * 255;
                        lsbData.data[dstIdx] = lsb;
                        lsbData.data[dstIdx + 1] = lsb;
                        lsbData.data[dstIdx + 2] = lsb;
                        lsbData.data[dstIdx + 3] = 255;
                    }
                }
                
                ctx.putImageData(lsbData, 0, 0);
            });
        }

        // Display detection results
        function displayDetectionResults(results) {
            document.getElementById('lsbRandomness').textContent = results.lsbRandomness + '%';
            document.getElementById('entropyScore').textContent = results.entropy;
            document.getElementById('chiSquare').textContent = results.chiSquare;
            document.getElementById('confidenceScore').textContent = results.confidence + '%';
            
            const indicator = document.getElementById('detectionIndicator');
            const title = document.getElementById('detectionTitle');
            const message = document.getElementById('detectionMessage');
            
            indicator.classList.remove('positive', 'negative', 'uncertain');
            
            if (results.confidence >= 60) {
                indicator.classList.add('positive');
                indicator.querySelector('.detection-icon').className = 'fas fa-exclamation-triangle detection-icon';
                title.textContent = 'Hidden Data Likely Detected';
                message.textContent = 'Analysis indicates this image may contain hidden data';
            } else if (results.confidence >= 30) {
                indicator.classList.add('uncertain');
                indicator.querySelector('.detection-icon').className = 'fas fa-question-circle detection-icon';
                title.textContent = 'Inconclusive Results';
                message.textContent = 'Some indicators present, but results are not definitive';
            } else {
                indicator.classList.add('negative');
                indicator.querySelector('.detection-icon').className = 'fas fa-check-circle detection-icon';
                title.textContent = 'No Hidden Data Detected';
                message.textContent = 'Analysis suggests this image is likely clean';
            }
            
            document.getElementById('detectResults').classList.add('visible');
        }

        // Decode message from image
        function decodeMessage() {
            if (!decodeImage) return;
            
            const btn = document.getElementById('decodeBtn');
            btn.classList.add('loading');
            btn.innerHTML = '<i class="fas fa-spinner"></i> Extracting...';
            btn.disabled = true;
            
            setTimeout(() => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = decodeImage.width;
                canvas.height = decodeImage.height;
                ctx.drawImage(decodeImage, 0, 0);
                
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                // Extract LSB bits
                let binaryStr = '';
                for (let i = 0; i < data.length; i += 4) {
                    binaryStr += (data[i] & 1).toString();
                    binaryStr += (data[i + 1] & 1).toString();
                    binaryStr += (data[i + 2] & 1).toString();
                }
                
                // Convert binary to text
                let message = '';
                let nullCount = 0;
                
                for (let i = 0; i < binaryStr.length; i += 8) {
                    const byte = binaryStr.substr(i, 8);
                    if (byte.length < 8) break;
                    
                    const charCode = parseInt(byte, 2);
                    
                    // Check for end marker (null bytes)
                    if (charCode === 0) {
                        nullCount++;
                        if (nullCount >= 3) break;
                        continue;
                    }
                    
                    nullCount = 0;
                    
                    // Only accept printable ASCII and common characters
                    if ((charCode >= 32 && charCode <= 126) || charCode === 10 || charCode === 13) {
                        message += String.fromCharCode(charCode);
                    }
                    
                    // Limit message length
                    if (message.length > 10000) break;
                }
                
                document.getElementById('decodedMessage').value = message || 'No hidden message found or message is encrypted';
                document.getElementById('decodeResults').classList.add('visible');
                
                btn.classList.remove('loading');
                btn.innerHTML = '<i class="fas fa-key"></i> Extract Message';
                btn.disabled = false;
            }, 100);
        }

        // Update capacity for encoding
        function updateCapacity() {
            if (!encodeImage) {
                document.getElementById('maxChars').textContent = '0';
                document.getElementById('charUsed').textContent = '0';
                document.getElementById('encodeBtn').disabled = true;
                return;
            }
            
            const maxChars = Math.floor((encodeImage.width * encodeImage.height * 3) / 8) - 10;
            const message = document.getElementById('secretMessage').value;
            
            document.getElementById('maxChars').textContent = maxChars.toLocaleString();
            document.getElementById('charUsed').textContent = message.length.toLocaleString();
            
            document.getElementById('encodeBtn').disabled = message.length === 0 || message.length > maxChars;
        }

        // Encode message into image
        function encodeMessage() {
            if (!encodeImage) return;
            
            const message = document.getElementById('secretMessage').value;
            if (!message) return;
            
            const btn = document.getElementById('encodeBtn');
            btn.classList.add('loading');
            btn.innerHTML = '<i class="fas fa-spinner"></i> Encoding...';
            btn.disabled = true;
            
            setTimeout(() => {
                const canvas = document.getElementById('encodedCanvas');
                const ctx = canvas.getContext('2d');
                canvas.width = encodeImage.width;
                canvas.height = encodeImage.height;
                ctx.drawImage(encodeImage, 0, 0);
                
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                // Convert message to binary with end marker
                let binaryMsg = '';
                for (let i = 0; i < message.length; i++) {
                    binaryMsg += message.charCodeAt(i).toString(2).padStart(8, '0');
                }
                // Add null terminator
                binaryMsg += '00000000'.repeat(3);
                
                // Embed message in LSB
                let msgIndex = 0;
                for (let i = 0; i < data.length && msgIndex < binaryMsg.length; i += 4) {
                    // Red channel
                    if (msgIndex < binaryMsg.length) {
                        data[i] = (data[i] & 0xFE) | parseInt(binaryMsg[msgIndex]);
                        msgIndex++;
                    }
                    // Green channel
                    if (msgIndex < binaryMsg.length) {
                        data[i + 1] = (data[i + 1] & 0xFE) | parseInt(binaryMsg[msgIndex]);
                        msgIndex++;
                    }
                    // Blue channel
                    if (msgIndex < binaryMsg.length) {
                        data[i + 2] = (data[i + 2] & 0xFE) | parseInt(binaryMsg[msgIndex]);
                        msgIndex++;
                    }
                }
                
                ctx.putImageData(imageData, 0, 0);
                document.getElementById('encodeResults').classList.add('visible');
                
                btn.classList.remove('loading');
                btn.innerHTML = '<i class="fas fa-wand-magic-sparkles"></i> Hide Message';
                btn.disabled = false;
            }, 100);
        }

        // Download functions
        function downloadAnalysis() {
            if (!analysisResults) return;
            
            showProcessing('Generating Report', 'Preparing analysis report...');
            
            setTimeout(() => {
                const report = `Steganography Analysis Report
=============================
Date: ${new Date().toLocaleString()}

LSB Randomness: ${analysisResults.lsbRandomness}%
Entropy Score: ${analysisResults.entropy}
Chi-Square Value: ${analysisResults.chiSquare}
Detection Confidence: ${analysisResults.confidence}%

Interpretation:
${analysisResults.confidence >= 60 ? 'Hidden data likely detected' : 
  analysisResults.confidence >= 30 ? 'Results inconclusive' : 
  'No hidden data detected'}
`;
                
                const blob = new Blob([report], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'stego-analysis-report.txt';
                a.click();
                URL.revokeObjectURL(url);
                
                hideProcessing();
            }, 500);
        }

        function downloadEncoded() {
            showProcessing('Preparing Download', 'Generating PNG image...');
            
            setTimeout(() => {
                const canvas = document.getElementById('encodedCanvas');
                const link = document.createElement('a');
                link.download = 'hidden-message.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                hideProcessing();
            }, 500);
        }

        function copyDecodedMessage() {
            const text = document.getElementById('decodedMessage').value;
            navigator.clipboard.writeText(text).then(() => {
                alert('Message copied to clipboard!');
            });
        }
        
        // Processing overlay helpers
        function showProcessing(title, subtitle) {
            document.getElementById('processingText').textContent = title;
            document.getElementById('processingSubtext').textContent = subtitle;
            document.getElementById('processingOverlay').classList.add('visible');
        }
        
        function hideProcessing() {
            document.getElementById('processingOverlay').classList.remove('visible');
        }

        // Clear functions
        function clearDetect() {
            detectImage = null;
            analysisResults = null;
            document.getElementById('detectPreview').style.display = 'none';
            document.getElementById('detectUploadIcon').style.display = 'block';
            document.getElementById('detectUploadText').textContent = 'Click to upload or drag & drop image here';
            document.getElementById('detectUploadZone').classList.remove('has-image');
            document.getElementById('detectBtn').disabled = true;
            document.getElementById('detectResults').classList.remove('visible');
            document.getElementById('detectInput').value = '';
        }

        function clearDecode() {
            decodeImage = null;
            document.getElementById('decodePreview').style.display = 'none';
            document.getElementById('decodeUploadIcon').style.display = 'block';
            document.getElementById('decodeUploadText').textContent = 'Click to upload or drag & drop image here';
            document.getElementById('decodeUploadZone').classList.remove('has-image');
            document.getElementById('decodeBtn').disabled = true;
            document.getElementById('decodeResults').classList.remove('visible');
            document.getElementById('decodeInput').value = '';
            document.getElementById('decodedMessage').value = '';
        }

        function clearEncode() {
            encodeImage = null;
            document.getElementById('encodePreview').style.display = 'none';
            document.getElementById('encodeUploadIcon').style.display = 'block';
            document.getElementById('encodeUploadText').textContent = 'Click to upload or drag & drop image here';
            document.getElementById('encodeUploadZone').classList.remove('has-image');
            document.getElementById('encodeBtn').disabled = true;
            document.getElementById('encodeResults').classList.remove('visible');
            document.getElementById('encodeInput').value = '';
            document.getElementById('secretMessage').value = '';
            document.getElementById('charUsed').textContent = '0';
            document.getElementById('maxChars').textContent = '0';
        }
    </script>
</body>
</html>
